# Libraries
library(ggraph)
library(igraph)
library(tidyverse)
library(RColorBrewer) 
# create a data frame giving the hierarchical structure of your individuals
level1_d1=data.frame(from="Emerging Technology", to=c('Data Systems', 'Quantum Tech', 'Human-computer Systems'))
level2_d1=data.frame(from="Data Systems", to=c('Data technologies', 'Network technologies'))
level2_d2=data.frame(from="Quantum Tech", to=c('Nanotech', 'Autonomous tech'))
level2_d3=data.frame(from="Human-computer Systems", to=c('Healthtech', 'ConvergeTech', 'Biotechnologies'))
level3_d1=data.frame(from="Data technologies", to=c('Energy management',
                                                    'Marketing automation',
                                                    'Deep learning',
                                                    'Data mining',
                                                    'Machine learning',
                                                    'Big data',
                                                    'Recommender system',
                                                    'Simulation',
                                                    'Internet of things',
                                                    'Speech recognition',
                                                    'Semantic search',
                                                    'Semantic Web',
                                                    'Legal technology',
                                                    'Data integration',
                                                    'Cloud computing',
                                                    'Edge computing',
                                                    'Blockchain'))
level3_d2=data.frame(from="Network technologies", to=c('5G',
                                                       'Unified communications',
                                                       'Financial technology',
                                                       'Local positioning system',
                                                       'Homomorphic encryption',
                                                       'Identity management',
                                                       'Computer security',
                                                       'Virtual assistant',
                                                       'Grid computing',
                                                       'Embedded software'))
level3_d3=data.frame(from="Nanotech", to=c('Laser science',
                                           'Quantum sensor',
                                           'Optical computing',
                                           'Quantum computing',
                                           'Smart material',
                                           'Fullerene',
                                           'Functionally graded material',
                                           'Semiconductor',
                                           'Nanomaterials',
                                           'Nanoparticle',
                                           'Carbon nanotube',
                                           'Graphene'))
level3_d4=data.frame(from="Autonomous tech", to=c('Autonomous underwater vehicle',
                                                  'Sensor',
                                                  'Lithium battery',
                                                  'Wind turbine design',
                                                  'Fleet management',
                                                  'Electric vehicle',
                                                  'Distributed acoustic sensing',
                                                  'Optical communication',
                                                  'Small satellite'))
level3_d5=data.frame(from="Healthtech", to=c('Human enhancement',
                                             'Artificial intelligence',
                                             'Health surveillance',
                                             'Virtual patient',
                                             'Medical device'))
level3_d6=data.frame(from="ConvergeTech", to=c('Quantum machine learning',
                                               '3D printing',
                                               'Augmented reality',
                                               'Virtual reality',
                                               'Assistive technology',
                                               'Wearable technology',
                                               'Computer vision',
                                               'Microgeneration',
                                               'Microgrid',
                                               'Smart grid',
                                               'Photovoltaics',
                                               'Grid energy storage',
                                               'Energy storage',
                                               'Wave power',
                                               'Robotics',
                                               'Autonomous robot',
                                               'Autonomous car'))
level3_d7=data.frame(from="Biotechnologies", to=c('Functional magnetic resonance imaging',
                                                  'Neuroscience',
                                                  'Medical robot',
                                                  'Clinical Oncology',
                                                  'Neurotechnology',
                                                  'Cell therapy',
                                                  'Regenerative medicine',
                                                  'Personalized medicine',
                                                  'Biocatalysis',
                                                  'Genetics',
                                                  'CRISPR',
                                                  'Whole genome sequencing',
                                                  'Bioinformatics',
                                                  'Microarray',
                                                  'Vaccine efficacy',
                                                  'Synthetic vaccine',
                                                  'Solar chemical',
                                                  'Fuel cell',
                                                  'Hydrogen fuel',
                                                  'Energy content of biofuel',
                                                  'Carbon capture and storage',
                                                  'Pharmaceutical engineering',
                                                  'Biomedical engineering',
                                                  'Synthetic biology',
                                                  'Biomaterial',
                                                  'Biotechnology',
                                                  'Nanotechnology',
                                                  'Nanomanufacturing',
                                                  'Biosensor',
                                                  'Biomining'))
edges=rbind(level1_d1, level2_d1, level2_d2, level2_d3, level3_d1, level3_d2, level3_d3, level3_d4, level3_d5, level3_d6, level3_d7)

h_var = 0.3
# create a vertices data.frame. One line per object of our hierarchy
vertices = data.frame(
  name = unique(c(as.character(edges$from), as.character(edges$to))) , 
  value = c(1,1,1,1,1,1,1,1,1,1,1,
            0.23251558191770674,
            0.008744616768973932,
            0.12638228798194096,
            0.10862122494485217,
            0.22135675061398974,
            0.32280444114930956,
            0.21546403994617222,
            0.14850183756457733,
            0.1608124887799084,
            0.08878227878721162,
            0.010053084188567502,
            0.014614291038559173,
            0.22036618549000164,
            0.1458618663271579,
            0.03377596708817065,
            0.032375354075647955,
            0.010688888779778463,
            0.022640172182685932,
            0.031933055229588156,
            0.280283857292165,
            0.3205929469190106,
            0.0004376915664133422,
            0.09953566948204047,
            0.14880591802124343,
            0.031053064817115016,
            0.016475632015727493,
            0.0377704785416482,
            0.05801025802853044,
            0.0064778351829174645,
            0.01783477951143208,
            0.024782557218288082,
            0.10213878248228825,
            0.0035476053277713,
            0.017355622428200632,
            0.05712566033641084,
            0.007500651264430749,
            0.012679233587047554,
            0.006404118708574165,
            0.008118026737055884,
            0.009850363884123428,
            0.138642259121161,
            0.018894453830117015,
            0.016116264203303907,
            0.06713727900816023,
            0.13288315956309069,
            0.0035936781242358624,
            0.025929769850255684,
            0.15221069767997458,
            0.17567096563972973,
            0.09714909862517614,
            0.04447867770688848,
            0.016687566879464478,
            0.10512890697283835,
            0.013550009440227783,
            0.019677691370014575,
            0.020004808224912966,
            0.06560305488589031,
            0.17062599442686016,
            0.07477614866198468,
            0.09595581319674398,
            0.00212856319666278,
            0.0012577873434825519,
            0.0160747986864858,
            0.018636446169915465,
            0.014250315946489131,
            0.08783317918004163,
            0.24487230592950235,
            0.21919132918015533,
            0.015148735477548097,
            0.03353638854655493,
            0.007896877314025984,
            0.08116183825197301,
            0.031684262128679516,
            0.028035296648686182,
            0.001520402283330557,
            0.06397668517069126,
            0.01987580439481219,
            0.009237595691144749,
            0.0009030268107054218,
            0.14776467282114433,
            0.004215660876507454,
            0.00819635049104564,
            0.02943130238156242,
            0.007846197237914966,
            0.00785541179720788,
            0.005330622550949862,
            0.03735121609382069,
            0.045759501448603315,
            0.027007873287526442,
            0.0029670880923178145,
            0.009979367714224202,
            0.03482181956791621,
            0.03311251881908095,
            0.022207087895919048,
            0.006980028664381194,
            0.15345927046416424,
            0.024911561048388854,
            0.000216542143383443,
            0.00379179114903348,
            0.000138218389393687),
  height = c(5,3,3,3,1,1,1,1,1,1,1,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var,
             h_var)
) 
# Let's add a column with the group of each name. It will be useful later to color points
vertices$group = edges$from[ match( vertices$name, edges$to ) ]

#Let's add information concerning the label we are going to add: angle, horizontal adjustement and potential flip
#calculate the ANGLE of the labels
vertices$id=NA
myleaves=which(is.na( match(vertices$name, edges$from) ))
nleaves=length(myleaves)
vertices$id[ myleaves ] = seq(1:nleaves)
vertices$angle= 90 - 360 * vertices$id / nleaves

# calculate the alignment of labels: right or left
# If I am on the left part of the plot, my labels have currently an angle < -90
vertices$hjust<-ifelse( vertices$angle < -90, 1, 0)

# flip angle BY to make them readable
vertices$angle<-ifelse(vertices$angle < -90, vertices$angle+180, vertices$angle)

# Create a graph object
mygraph <- graph_from_data_frame(edges, vertices=vertices )


# Make the plot
p <- ggraph(mygraph, layout = 'dendrogram', circular = TRUE, height = height) + 
  # geom_edge_diagonal(colour = "grey") +
  geom_edge_elbow(colour = "grey", edge_width = 0.4) +
  scale_edge_colour_distiller(palette = "RdPu") +
  geom_node_text(aes(x = x*1.15, y=y*1.15, filter = leaf, label=name, angle = angle, hjust=hjust, colour=group), size=2.7, alpha=1) +
  geom_node_point(aes(filter = leaf, x = x*1.07, y=y*1.07, colour=group, size=value, alpha=0.2)) +
  scale_colour_manual(values= rep( brewer.pal(7,"Dark2") , 30)) +
  scale_size_continuous( range = c(0.1,10) ) +
  coord_fixed() + 
  theme_void() +
  theme(
    legend.position="none",
    plot.margin=unit(c(0,0,0,0),"cm"),
  ) +
  expand_limits(x = c(-1.8, 1.8), y = c(-1.8, 1.8))

show(p)

# Save the plot as a PDF
ggsave("ET100.pdf", plot = p, width = 10, height = 10)